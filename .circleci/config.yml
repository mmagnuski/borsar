version: 2.1
"-": &dockerbuild
  steps:
    - checkout
    - run:
        name: Create conda env
        command: |
          conda env create -f environment.yml
          source activate borsar
          if [ "${USE_NUMBA}" == "yes" ]; then
            conda install numba -y;
          fi
          if [ "${MNE_VERSION}" == "current" ]; then
            pip install mne
          fi
          if [ "${MNE_VERSION}" == "0.23" ]; then
            pip install mne==0.23.4;
          fi
          if [ "${MNE_VERSION}" == "0.20" ]; then
            pip install mne==0.20.8;
          fi
          pip install codecov tqdm
          hash -r pytest
    - run:
        name: Run tests
        command: |
          source activate borsar
          python -m pytest --cov=borsar borsar/
    - run:
        name: Update coverage
        command: |
          source activate borsar
          codecov
jobs:
  build-mne-current-numba:
    docker:
      - image: continuumio/conda-ci-linux-64-python3.9
    environment:
      MNE_VERSION: "current"
      USE_NUMBA: "yes"
    <<: *dockerbuild
  build-mne-0.23-numba:
    docker:
      - image: continuumio/conda-ci-linux-64-python3.9
    environment:
      MNE_VERSION: "0.23"
      USE_NUMBA: "yes"
    <<: *dockerbuild
  build-mne-0.20-nonumba:
    docker:
      - image: continuumio/conda-ci-linux-64-python3.9
    environment:
      MNE_VERSION: "0.20"
      USE_NUMBA: "no"
    <<: *dockerbuild
